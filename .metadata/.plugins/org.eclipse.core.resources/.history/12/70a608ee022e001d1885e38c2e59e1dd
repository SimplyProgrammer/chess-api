package org.ugp.api.chess.enginev2;


import java.util.LinkedList;
import java.util.Scanner;

public class Game {
	public static final int BLACK = 0;
	public static final int WHITE = 1;
	public final int xBlkKing = 1;
	public final int yBlkKing = 5;
	public final int xWhtKing = 0;
	public final int yWhtKing = 7;
	Scanner userInput = new Scanner(System.in);
	
	private int currentPlayer;
	private Board chessBoard;
	private LinkedList<ChessPiece> blackPieces;
	private LinkedList<ChessPiece> whitePieces;
	private King blackKing;
	private King whiteKing;
	
	public Game(){
		chessBoard = new Board(8,8);
		currentPlayer = WHITE;
		blackPieces = new LinkedList<ChessPiece>();
		whitePieces = new LinkedList<ChessPiece>();
		
		blackKing = new King(chessBoard, BLACK, xBlkKing, yBlkKing);
		whiteKing = new King(chessBoard, WHITE, xWhtKing, yWhtKing);
		blackPieces.add(blackKing);
		whitePieces.add(whiteKing);
	}
	
	
	
	
	public void testSetup() {
		blackKing.moveTo(5, 0);
		whiteKing.moveTo(7, 1);
		this.addPawn(BLACK, 1, 1);
		this.addPawn(BLACK, 2, 1);
		this.addPawn(BLACK, 3, 1);
		this.addPawn(BLACK, 4, 1);
		this.addPawn(BLACK, 5, 1);
		this.addPawn(BLACK, 6, 1);
		this.addQueen(BLACK, 4, 0);
		this.addRook(BLACK, 3, 0);
		this.addBishop(BLACK, 2, 0);
		currentPlayer = BLACK;
	}
	
	
	public void gameLoop(){
		boolean continueGame = true;
		
		testSetup();
		
		while(continueGame){
			System.out.println(chessBoard);
			
			if (isGameOver()){
				break;
			}
			
			System.out.print("Which piece to move? X-loc: ");
			int nextX = userInput.nextInt();
			System.out.print("Y-loc: ");
			int nextY = userInput.nextInt();
			
			ChessPiece target = chessBoard.pieceAt(nextX, nextY);
			if (target == null){
				System.out.println("That location is invalid");
				continueGame = false;
			}
			else if (target.getColor() != currentPlayer){
				System.out.println("That is not your piece");
				continueGame = false;
			}
			else {
				System.out.print("Where to move this piece? x-loc: ");
				nextX = userInput.nextInt();
				System.out.print("Y-loc: ");
				nextY = userInput.nextInt();
				
				if (target.canMoveTo(nextX, nextY)){
					target.moveTo(nextX, nextY);
				}
				else {
					System.out.println("Cannot move there");
				}
			}
		}
	}
	
	
	public boolean isGameOver(){
		if (isCheckmate(BLACK) || isCheckmate(WHITE)){
			System.out.println("CHECKMATE");
			return true;
		}
		else if (!canMove(currentPlayer)){
			System.out.println("STALEMATE");
			return true;
		}
		return false;
	}
	
	
	public boolean isCheckmate(int color){	
		if (isKingInCheck(color)){
			if(!canMove(color))
				return true;
		}
		
		return false;
	}
	
	
	public boolean canMove(int player){
		int oldX, oldY;
		ChessPiece target;
		LinkedList<ChessPiece> checkPieces;
		
		if (player == BLACK)
			checkPieces = blackPieces;
		else
			checkPieces = whitePieces;
		
		for (int x = 0; x < chessBoard.getXDimension(); x++){
			for (int y = 0; y < chessBoard.getYDimension(); y++){	
				
				
				for (ChessPiece currentPiece : checkPieces){
					if (currentPiece.canMoveTo(x, y)){
						
						target = chessBoard.pieceAt(x, y);
						oldX = currentPiece.getX();
						oldY = currentPiece.getY();
						
						currentPiece.moveTo(x, y);
						
						if (!isKingInCheck(player)){
							currentPiece.moveTo(oldX, oldY);
							if (target != null)
								target.moveTo(x, y);
							return true;
						} else {
							currentPiece.moveTo(oldX, oldY);
							if (target != null)
								target.moveTo(x, y);
						}
					}
				}
			}
		}
		return false;
	}
	
	
	public boolean isKingInCheck(int color){
		boolean result = false;
		
		LinkedList<ChessPiece> originalList;
		King kingInQuestion;
		
		if (color == BLACK){
			originalList = whitePieces;
			kingInQuestion = blackKing;
		} else {
			originalList = blackPieces;
			kingInQuestion = whiteKing;
		}
		
		int xKingLoc = kingInQuestion.getX();
		int yKingLoc = kingInQuestion.getY();
		
		for (ChessPiece currentPiece : originalList){
			if (currentPiece.canMoveTo(xKingLoc, yKingLoc)){
				result = true;
			}
		}
		
		return result;
	}
	
	
	public void removePiece(ChessPiece removeThisPiece){
		removeThisPiece.removePiece();
		int color = removeThisPiece.getColor();
		
		if (color == BLACK)
			blackPieces.remove(removeThisPiece);
		else
			whitePieces.remove(removeThisPiece);
	}
	
	public void switchPlayerTurn(){
		if (currentPlayer == WHITE)
			currentPlayer = BLACK;
		else currentPlayer = WHITE;
	}
	
	public Queen addQueen(int color, int xloc, int yloc){
		Queen queen = new Queen(chessBoard, color, xloc, yloc);
		pieceToColorHelper(queen, color);
		
		return queen;
	}
	
	public Knight addKnight(int color, int xloc, int yloc){
		Knight knight = new Knight(chessBoard, color, xloc, yloc);
		pieceToColorHelper(knight, color);
		
		return knight;
	}
	
	public Rook addRook(int color, int xloc, int yloc){
		Rook rook = new Rook(chessBoard, color, xloc, yloc);
		pieceToColorHelper(rook, color);
		
		return rook;
	}
	
	public Bishop addBishop(int color, int xloc, int yloc){
		Bishop bishop = new Bishop(chessBoard, color, xloc, yloc);
		pieceToColorHelper(bishop, color);
		
		return bishop;
	}
	
	public Pawn addPawn(int color, int xloc, int yloc){
		Pawn pawn = new Pawn(chessBoard, color, xloc, yloc);
		pieceToColorHelper(pawn, color);
		
		return pawn;
	}
	
	private void pieceToColorHelper(ChessPiece piece, int color){
		if (color == BLACK)
			blackPieces.add(piece);
		else
			whitePieces.add(piece);
	}
	
	public int getPlayerTurn(){
		return currentPlayer;
	}
	
	public void setPlayer(int player){
		currentPlayer = player;
	}
	
	public King getBlackKing(){
		return blackKing;
	}
	
	public King getWhiteKing(){
		return whiteKing;
	}
}
